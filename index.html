<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Poulton Consultancy - Financial Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    :root {
      /* Brand */
      --primary-color:#2E5C8A; --secondary-color:#4A90A4; --accent-color:#87C4A1;
      --warning-color:#F4A261; --danger-color:#E76F51; --success-color:#2A9D8F;
      --neutral-light:#F8F9FA; --neutral-dark:#343A40;
      --text-primary:#2C3E50; --text-secondary:#6C757D;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Inter','Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,var(--primary-color) 0%,var(--secondary-color) 100%);
      color:var(--text-primary);line-height:1.6;min-height:100vh;
    }
    .container{max-width:1600px;margin:0 auto;padding:20px}
    .header{
      background:rgba(255,255,255,.98);backdrop-filter:blur(15px);border-radius:25px;
      padding:40px;margin-bottom:30px;box-shadow:0 25px 50px rgba(0,0,0,.1);
      text-align:center;border:1px solid rgba(255,255,255,.2);
    }
    .header h1{color:var(--primary-color);font-size:3em;margin-bottom:10px;font-weight:800;letter-spacing:-.02em}
    .header .tagline{color:var(--secondary-color);font-size:1.2em;margin-bottom:20px;font-weight:500}
    .header .company-info{display:flex;justify-content:center;gap:30px;margin-top:20px;flex-wrap:wrap}
    .company-info span{color:var(--text-secondary);font-size:.9em;display:flex;align-items:center;gap:5px}

    .year-selector{display:flex;gap:15px;margin-bottom:30px;justify-content:center;flex-wrap:wrap}
    .year-btn{
      padding:12px 25px;border:none;border-radius:30px;background:var(--neutral-light);
      color:var(--primary-color);cursor:pointer;font-weight:600;font-size:1em;transition:.3s;border:2px solid transparent;
    }
    .year-btn.active{background:var(--primary-color);color:#fff;transform:scale(1.05);box-shadow:0 10px 25px rgba(46,92,138,.3)}
    .year-btn:hover{background:var(--secondary-color);color:#fff}

    .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:30px;margin-bottom:30px}
    .card{
      background:rgba(255,255,255,.98);backdrop-filter:blur(15px);border-radius:25px;padding:30px;
      box-shadow:0 20px 40px rgba(0,0,0,.1);border:1px solid rgba(255,255,255,.2);transition:.3s;position:relative;overflow:hidden
    }
    .card:hover{transform:translateY(-8px);box-shadow:0 30px 60px rgba(0,0,0,.15)}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--accent-color),var(--secondary-color));border-radius:25px 25px 0 0}
    .card h2{color:var(--primary-color);font-size:1.5em;margin-bottom:25px;font-weight:700;display:flex;align-items:center;gap:10px}

    .metric-row{display:flex;justify-content:space-between;align-items:center;padding:18px 0;border-bottom:1px solid rgba(108,117,125,.1);transition:.2s}
    .metric-row:hover{background:rgba(74,144,164,.05);border-radius:8px;margin:0 -10px;padding:18px 10px}
    .metric-row:last-child{border-bottom:none}
    .metric-label{font-weight:500;color:var(--text-primary);font-size:1.05em}
    .metric-value{font-weight:700;font-size:1.3em}
    .positive{color:var(--success-color)} .negative{color:var(--danger-color)} .warning{color:var(--warning-color)} .neutral{color:var(--primary-color)}

    .editable-section{background:rgba(135,196,161,.1);border:2px dashed var(--accent-color);border-radius:15px;padding:20px;margin:20px 0}
    .editable-section h3{color:var(--accent-color);margin-bottom:15px;font-size:1.2em}
    .input-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px}
    .input-field{display:flex;flex-direction:column}
    .input-field label{font-weight:600;color:var(--text-primary);margin-bottom:5px;font-size:.9em}
    .input-field input,.input-field select,.input-field textarea{
      padding:12px;border:2px solid rgba(74,144,164,.2);border-radius:10px;font-size:1em;transition:border-color .2s;background:#fff
    }
    .input-field textarea{resize:vertical;min-height:80px}
    .input-field input:focus,.input-field select:focus,.input-field textarea:focus{
      outline:none;border-color:var(--secondary-color);box-shadow:0 0 0 3px rgba(74,144,164,.1)
    }

    .btn{padding:12px 25px;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:.2s;font-size:1em}
    .btn-primary{background:var(--primary-color);color:#fff}.btn-primary:hover{background:var(--secondary-color);transform:translateY(-2px)}
    .btn-danger{background:var(--danger-color);color:#fff}.btn-danger:hover{background:#c85a3a;transform:translateY(-2px)}
    .btn-success{background:var(--success-color);color:#fff}.btn-success:hover{background:#238b7a;transform:translateY(-2px)}
    .btn-warning{background:var(--warning-color);color:#fff}.btn-warning:hover{background:#e8944e;transform:translateY(-2px)}
    .btn-outline{background:#fff;color:var(--primary-color);border:2px solid var(--primary-color)}
    .btn-outline:hover{background:var(--primary-color);color:#fff}

    .invoice-table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff;border-radius:15px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,.05)}
    .invoice-table th,.invoice-table td{padding:15px;text-align:left;border-bottom:1px solid rgba(108,117,125,.1)}
    .invoice-table th{background:var(--neutral-light);font-weight:700;color:var(--text-primary);text-transform:uppercase;font-size:.85em;letter-spacing:.5px}
    .invoice-table tbody tr:hover{background:rgba(74,144,164,.05)}

    .status-badge{padding:6px 15px;border-radius:20px;font-size:.8em;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
    .status-paid{background:rgba(42,157,143,.15);color:var(--success-color)}
    .status-unpaid{background:rgba(231,111,81,.15);color:var(--danger-color)}
    .status-partially{background:rgba(244,162,97,.15);color:var(--warning-color)}

    /* Cost category badges (table) */
    .status-licensing{background:rgba(46,92,138,.15);color:var(--primary-color)}
    .status-office{background:rgba(74,144,164,.15);color:var(--secondary-color)}
    .status-marketing{background:rgba(135,196,161,.15);color:var(--accent-color)}
    .status-travel{background:rgba(244,162,97,.15);color:var(--warning-color)}
    .status-technology{background:rgba(231,111,81,.15);color:var(--danger-color)}
    .status-professional{background:rgba(42,157,143,.15);color:var(--success-color)}
    .status-training{background:rgba(155,89,182,.15);color:#9b59b6}
    .status-insurance{background:rgba(52,73,94,.15);color:#34495e}
    .status-utilities{background:rgba(241,196,15,.15);color:#f1c40f}
    .status-other{background:rgba(149,165,166,.15);color:#95a5a6}
    .status-salary{background:rgba(52, 152, 219, .15);color:#2c7fbf}

    .chart-container{position:relative;height:350px;margin-top:25px}
    .missing-invoices{background:rgba(244,162,97,.1);border:2px solid var(--warning-color);border-radius:20px;padding:25px;margin-top:25px}
    .missing-invoices h3{color:var(--warning-color);margin-bottom:20px;font-size:1.3em}
    .missing-invoice-item{background:#fff;padding:15px 20px;margin:10px 0;border-radius:12px;border-left:5px solid var(--warning-color);box-shadow:0 3px 10px rgba(0,0,0,.05)}

    .full-width{grid-column:1 / -1}
    .exchange-note{font-size:.9em;color:var(--text-secondary);text-align:center;margin-top:30px;font-style:italic;padding:20px;background:rgba(255,255,255,.7);border-radius:15px}

    .tax-section{background:linear-gradient(135deg,rgba(46,92,138,.05),rgba(74,144,164,.05));border-radius:20px;padding:25px;margin-top:20px}
    .summary-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:20px}
    .summary-card{background:#fff;padding:20px;border-radius:15px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.05);border-top:4px solid}
    .summary-card.revenue{border-top-color:var(--success-color)}
    .summary-card.costs{border-top-color:var(--danger-color)}
    .summary-card.tax{border-top-color:var(--warning-color)}
    .summary-card.profit{border-top-color:var(--primary-color)}
    .summary-card h4{color:var(--text-secondary);font-size:.9em;margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px}
    .summary-card .amount{font-size:1.8em;font-weight:800;margin-bottom:5px;line-height:1.2}
    .summary-card small{display:block;font-size:.75em;color:var(--text-secondary);margin-top:5px}

    .print-button{
      position:fixed;bottom:30px;right:30px;background:var(--primary-color);color:#fff;border:none;border-radius:50px;
      padding:15px 25px;font-weight:600;cursor:pointer;box-shadow:0 10px 30px rgba(46,92,138,.3);transition:.3s;
    }
    .print-button:hover{transform:translateY(-3px);box-shadow:0 15px 40px rgba(46,92,138,.4)}

    .cost-sheet-section{background:rgba(231,111,81,.1);border:2px dashed var(--danger-color);border-radius:15px;padding:20px;margin:20px 0}
    .cost-sheet-section h3{color:var(--danger-color);margin-bottom:15px;font-size:1.2em}
    .cost-summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:20px}
    .cost-category-card{background:#fff;padding:15px;border-radius:10px;border-left:4px solid;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .cost-category-card.licensing{border-left-color:var(--primary-color)}
    .cost-category-card.office{border-left-color:var(--secondary-color)}
    .cost-category-card.marketing{border-left-color:var(--accent-color)}
    .cost-category-card.travel{border-left-color:var(--warning-color)}
    .cost-category-card.technology{border-left-color:var(--danger-color)}
    .cost-category-card.professional{border-left-color:var(--success-color)}
    .cost-category-card.training{border-left-color:#9b59b6}
    .cost-category-card.insurance{border-left-color:#34495e}
    .cost-category-card.utilities{border-left-color:#f1c40f}
    .cost-category-card.other{border-left-color:#95a5a6}
    .cost-category-card.salary{border-left-color:#2c7fbf}
    .cost-category-card h4{font-size:.9em;color:var(--text-secondary);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
    .cost-category-card .amount{font-size:1.4em;font-weight:700;color:var(--text-primary)}
    .cost-category-card .count{font-size:.8em;color:var(--text-secondary);margin-top:5px}

    .wix-integration-section{background:rgba(155,89,182,.1);border:2px dashed #9b59b6;border-radius:15px;padding:20px;margin:20px 0}
    .wix-integration-section h3{color:#9b59b6;margin-bottom:15px;font-size:1.2em}
    .integration-status{display:flex;align-items:center;gap:10px;padding:10px 15px;border-radius:8px;margin:10px 0}
    .integration-status.connected{background:rgba(42,157,143,.1);color:var(--success-color)}
    .integration-status.disconnected{background:rgba(231,111,81,.1);color:var(--danger-color)}
    .integration-status.pending{background:rgba(244,162,97,.1);color:var(--warning-color)}

    @media print{body{background:#fff}.print-button{display:none}.year-selector{display:none}.card{box-shadow:none;border:1px solid #ddd}}
    @media(max-width:768px){
      .dashboard-grid{grid-template-columns:1fr}
      .header h1{font-size:2em}
      .company-info{flex-direction:column;gap:10px}
      .input-group{grid-template-columns:1fr}
      .cost-summary-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Poulton Consultancy</h1>
      <div class="tagline">Leadership ‚Ä¢ Education ‚Ä¢ Excellence</div>
      <div class="company-info">
        <span>üìç Dubai, UAE (Meydan Free Zone)</span>
        <span>üìß info@poultonconsults.com</span>
        <span>üåê www.poultonconsults.com</span>
        <span>üì± +971 56 274 8890</span>
      </div>
    </div>

    <!-- Editable Settings -->
    <div class="card editable-section">
      <h3>üíº Business Settings (Customize Your Data)</h3>
      <div class="input-group">
        <div class="input-field">
          <label>UAE Tax Rate (%)</label>
          <input type="number" id="taxRate" value="0" step="0.1" onchange="updateCalculations()">
        </div>
        <div class="input-field">
          <label>USD to AED Exchange Rate</label>
          <input type="number" id="exchangeRate" value="3.67" step="0.01" onchange="updateCalculations()">
        </div>
        <div class="input-field">
          <label>Tax Year</label>
          <select id="taxYear" onchange="updateCalculations()">
            <option value="2024">2024</option><option value="2025" selected>2025</option>
            <option value="2026">2026</option><option value="2027">2027</option>
            <option value="2028">2028</option><option value="2029">2029</option>
            <option value="2030">2030</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Wix Integration -->
    <div class="card wix-integration-section">
      <h3>üîó Wix Site Integration</h3>
      <div class="input-group">
        <div class="input-field">
          <label>Wix Site URL</label>
          <input type="url" id="wixSiteUrl" placeholder="https://yoursite.wixsite.com/mysite" onchange="saveWixSettings()">
        </div>
        <div class="input-field">
          <label>Wix API Key</label>
          <input type="password" id="wixApiKey" placeholder="Enter your Wix API key" onchange="saveWixSettings()">
        </div>
        <div class="input-field">
          <label>Auto-Sync Frequency</label>
          <select id="autoSyncFreq" onchange="saveWixSettings()">
            <option value="manual">Manual Only</option><option value="hourly">Every Hour</option>
            <option value="daily">Daily</option><option value="weekly">Weekly</option>
          </select>
        </div>
      </div>
      <div class="input-group">
        <button class="btn btn-primary" onclick="testWixConnection()">Test Connection</button>
        <button class="btn btn-success" onclick="syncWithWix()">Sync Now</button>
        <button class="btn btn-warning" onclick="setupWixWebhook()">Setup Auto-Sync</button>
        <button class="btn btn-outline" onclick="seedDemo()">Load Demo Data</button>
        <button class="btn btn-danger" onclick="clearAll()">Clear All</button>
      </div>
      <div id="wixConnectionStatus" class="integration-status disconnected">
        <span>üî¥</span> Not Connected to Wix
      </div>
    </div>

    <!-- Views -->
    <div class="year-selector">
      <button class="year-btn active" onclick="setView('combined', event)">Combined View</button>
      <button class="year-btn" onclick="setView('2024', event)">2024</button>
      <button class="year-btn" onclick="setView('2025', event)">2025</button>
      <button class="year-btn" onclick="setView('2026', event)">2026</button>
      <button class="year-btn" onclick="setView('2027', event)">2027</button>
      <button class="year-btn" onclick="setView('2028', event)">2028</button>
      <button class="year-btn" onclick="setView('2029', event)">2029</button>
      <button class="year-btn" onclick="setView('2030', event)">2030</button>
    </div>

    <!-- Summary -->
    <div class="summary-metrics">
      <div class="summary-card revenue"><h4>Total Revenue</h4><div class="amount positive" id="totalRevenue">AED 0</div></div>
      <div class="summary-card costs"><h4>Total Costs</h4><div class="amount negative" id="totalCosts">AED 0</div></div>
      <div class="summary-card tax"><h4>Tax Due</h4><div class="amount warning" id="totalTax">AED 0</div></div>
      <div class="summary-card profit"><h4>Net Profit</h4><div class="amount positive" id="netProfit">AED 0</div></div>
    </div>

    <div class="dashboard-grid">
      <div class="card">
        <h2>üìä Revenue Analysis</h2>
        <div id="revenueSummary">
          <div class="metric-row"><span class="metric-label">Invoices Issued</span><span class="metric-value neutral" id="totalInvoiced">0 Invoices</span></div>
          <div class="metric-row"><span class="metric-label">Payments Collected</span><span class="metric-value positive" id="totalCollected">AED 0</span></div>
          <div class="metric-row"><span class="metric-label">Outstanding Amounts</span><span class="metric-value warning" id="totalOutstanding">AED 0</span></div>
          <div class="metric-row"><span class="metric-label">Collection Rate</span><span class="metric-value positive" id="collectionRate">100%</span></div>
        </div>
      </div>

      <div class="card">
        <h2>üí± Currency Breakdown</h2>
        <div id="currencyBreakdown">
          <div class="metric-row"><span class="metric-label">USD Revenue</span><span class="metric-value positive" id="usdRevenue">$0</span></div>
          <div class="metric-row"><span class="metric-label">AED Revenue</span><span class="metric-value positive" id="aedRevenue">AED 0</span></div>
          <div class="metric-row"><span class="metric-label">USD Outstanding</span><span class="metric-value warning" id="usdOutstanding">$0</span></div>
          <div class="metric-row"><span class="metric-label">AED Outstanding</span><span class="metric-value warning" id="aedOutstanding">AED 0</span></div>
        </div>
      </div>

      <div class="card">
        <h2>üè¢ Client Portfolio</h2>
        <div id="clientAnalysis"><div class="metric-row"><span class="metric-label">No data available</span><span class="metric-value">-</span></div></div>
      </div>

      <div class="card">
        <h2>üìà Revenue Trends</h2>
        <div class="chart-container"><canvas id="monthlyChart"></canvas></div>
      </div>

      <!-- COSTS -->
      <div class="card full-width">
        <h2>üí∞ Comprehensive Cost Sheet</h2>

        <div class="cost-sheet-section">
          <h3>üìä Cost Summary by Category</h3>
          <div class="cost-summary-grid" id="costSummaryGrid"></div>
        </div>

        <div class="editable-section">
          <h3>‚ûï Add New Cost/Expense</h3>
          <div class="input-group">
            <div class="input-field"><label>Description *</label><input type="text" id="newCostDesc" placeholder="e.g., Office Rent, Software License, Travel Expense"></div>
            <div class="input-field"><label>Date *</label><input type="date" id="newCostDate"></div>
            <div class="input-field"><label>Amount *</label><input type="number" id="newCostAmount" placeholder="0.00" step="0.01"></div>
            <div class="input-field"><label>Currency</label>
              <select id="newCostCurrency"><option value="AED">AED</option><option value="USD">USD</option></select></div>
            <div class="input-field"><label>Category</label>
              <select id="newCostCategory">
                <option value="Licensing">Licensing & Renewals</option>
                <option value="Office">Office Expenses</option>
                <option value="Marketing">Marketing & Advertising</option>
                <option value="Travel">Travel & Transport</option>
                <option value="Technology">Technology & Software</option>
                <option value="Professional">Professional Services</option>
                <option value="Training">Training & Development</option>
                <option value="Insurance">Insurance</option>
                <option value="Utilities">Utilities</option>
                <option value="Salary">Salary</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="input-field"><label>Tax Deductible</label><select id="newCostDeductible"><option value="true">Yes</option><option value="false">No</option></select></div>
          </div>
          <div class="input-group">
            <div class="input-field" style="grid-column:1 / -1;"><label>Notes (Optional)</label><textarea id="newCostNotes" placeholder="Additional notes about this expense..."></textarea></div>
          </div>
          <div class="input-group">
            <button class="btn btn-primary" onclick="addNewCost()">Add Cost</button>
            <button class="btn btn-warning" onclick="addRecurringCost()">Add as Recurring</button>
            <button class="btn btn-success" onclick="importCostsFromFile()">Import from File</button>
            <button class="btn btn-outline" onclick="exportCostsCSV()">Download Costs (CSV)</button>
          </div>
        </div>

        <table class="invoice-table" id="costTable">
          <thead><tr>
            <th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th>Tax Deductible</th><th>Notes</th><th>Actions</th>
          </tr></thead>
          <tbody id="costTableBody"></tbody>
        </table>

        <div class="summary-metrics" style="margin-top:25px;">
          <div class="summary-card costs"><h4>Total Expenses</h4><div class="amount negative" id="totalExpenses">AED 0</div></div>
          <div class="summary-card tax"><h4>Tax Deductible</h4><div class="amount warning" id="deductibleTotal">AED 0</div></div>
          <div class="summary-card costs"><h4>Non-Deductible</h4><div class="amount negative" id="nonDeductibleTotal">AED 0</div></div>
          <div class="summary-card profit"><h4>Monthly Average</h4><div class="amount neutral" id="monthlyAverage">AED 0</div></div>
        </div>
      </div>

      <!-- INVOICES -->
      <div class="card full-width">
        <h2>üìã Invoice Management</h2>
        <div class="editable-section">
          <h3>‚ûï Add New Invoice Manually</h3>
          <div class="input-group">
            <div class="input-field"><label>Invoice Number</label><input type="text" id="newInvoiceNum" placeholder="e.g., 32"></div>
            <div class="input-field"><label>Date</label><input type="date" id="newInvoiceDate"></div>
            <div class="input-field"><label>Client Name</label><input type="text" id="newInvoiceClient" placeholder="Client Name"></div>
            <div class="input-field"><label>Amount</label><input type="number" id="newInvoiceAmount" placeholder="0.00" step="0.01"></div>
            <div class="input-field"><label>Currency</label>
              <select id="newInvoiceCurrency"><option value="AED">AED</option><option value="USD">USD</option></select></div>
            <div class="input-field"><label>Status</label>
              <select id="newInvoiceStatus"><option value="Unpaid">Unpaid</option><option value="Paid">Paid</option><option value="Partially Paid">Partially Paid</option></select></div>
          </div>
          <div class="input-group">
            <button class="btn btn-primary" onclick="addNewInvoice()">Add Invoice</button>
            <button class="btn btn-outline" onclick="exportInvoicesCSV()">Download Invoices (CSV)</button>
            <button class="btn btn-success" onclick="importInvoicesFromFile()">Import from File</button>
          </div>
        </div>

        <table class="invoice-table" id="invoiceTable">
          <thead><tr>
            <th>Invoice #</th><th>Date</th><th>Client</th><th>Amount</th><th>Status</th><th>Actions</th>
          </tr></thead>
          <tbody id="invoiceTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="exchange-note">
      üí° <strong>Note:</strong> All amounts are calculated using the current exchange rate.
      USD amounts are converted to AED for summary calculations. Data is saved locally and can sync with your Wix site.
    </div>
  </div>

  <button class="print-button" onclick="window.print()">üñ®Ô∏è Print Dashboard</button>

 
<script>
/* ===== Live mode: always read CSVs, ignore localStorage when ?live=1 ===== */
const LIVE_MODE = new URLSearchParams(location.search).get('live') === '1';
const BUILD = (document.currentScript && document.currentScript.getAttribute('data-build')) || Date.now();
const INVOICES_URL = `./invoices.csv?v=${BUILD}`;
const COSTS_URL    = `./costs.csv?v=${BUILD}`;
const FX = { AED: 1, USD: 3.67 };

const money = n => Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const num = v => { const n = Number(String(v??'').replace(/[, ]/g,'')); return isFinite(n)?n:0; };
const toAED = (amt, cur='AED') => num(amt) * (FX[(cur||'AED').toUpperCase().trim()] ?? 1);

const monthKey = (d)=>{
  if(!d) return 'Unknown';
  const iso = new Date(String(d).trim());
  if(!isNaN(iso)) return `${iso.getFullYear()}-${String(iso.getMonth()+1).padStart(2,'0')}`;
  return 'Unknown';
};

const csv = async (url)=>{
  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error(`Load fail ${url} ${res.status}`);
  const text = await res.text();
  const lines = text.split(/\r?\n/).filter(Boolean);
  const headers = lines.shift().split(',').map(s=>s.trim());
  return lines.map(line=>{
    const cells = line.split(',').map(s=>s.trim());
    const o={}; headers.forEach((h,i)=>o[h]=cells[i]); return o;
  });
};

// Replace/save guards so viewers don‚Äôt write localStorage in live mode
const _saveData = window.saveData;
window.saveData = function(){
  if (!LIVE_MODE && typeof _saveData === 'function') _saveData();
};

// On first load in LIVE_MODE, ignore any localStorage and hydrate from CSV
(async ()=>{
  try{
    if('serviceWorker' in navigator){
      navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r=>r.unregister()));
    }

    if (LIVE_MODE) {
      // clear viewer storage so no stale data wins
      localStorage.removeItem('poultonFinancialData');
      localStorage.removeItem('poultonSettings');
    }

    const [invRaw, costRaw] = await Promise.all([csv(INVOICES_URL), csv(COSTS_URL)]);

    // Map CSV ‚Üí your app‚Äôs structure, then redraw everything
    const invoices = invRaw.map(r=>({
      num:       r['Invoice #'] || r.num || '',
      date:      r.Date || r.date,
      client:    r.Client || r.client || '',
      currency:  (r.Currency || r.currency || 'AED').toUpperCase(),
      amount:    num(r.Amount || r.amount),
      status:    r.Status || r.status || 'Unpaid',
      paidAmount:num(r['Paid Amount'] || r.paidAmount || (/(paid|success|cleared|complete)/i.test(r.Status||'') ? r.Amount : 0))
    }));

    const expenses = costRaw.map(r=>({
      id:        'cost_'+crypto.randomUUID?.() || String(Math.random()).slice(2),
      description:r.Description || r.description || 'Expense',
      date:      r.Date || r.date,
      category:  r.Category || r.category || 'Other',
      amount:    num(r.Amount || r.amount),
      currency:  (r.Currency || r.currency || 'AED').toUpperCase(),
      deductible:String(r['Tax Deductible'] || r.deductible || '').toLowerCase().startsWith('y'),
      notes:     r.Notes || r.notes || ''
    }));

    // Put CSV data into your global model
    if (window.financialData) {
      window.financialData.invoices = invoices;
      window.financialData.expenses = expenses;
    }

    // Finally redraw
    if (typeof window.updateDashboard === 'function') {
      window.updateDashboard();
    }
  } catch (e){
    console.warn('Live CSV load failed; falling back to seeded/local data:', e);
    // If CSVs fail, your existing seeded+localStorage behavior still works.
  }
})();
</script>

</body>
</html>
