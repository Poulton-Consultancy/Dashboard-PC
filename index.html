<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Poulton Consultancy – Financial Dashboard</title>

  <!-- Cache hardening -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- Fonts (optional) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>

  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>
  <!-- PapaParse (robust CSV parser) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>

  <style>
    :root{
      --pc-blue:#1a3a5c; --pc-gold:#c8aa6e; --pc-white:#fff; --pc-bg:#f7f8fb; --pc-text:#243042;
      --ok:#2a9d8f; --warn:#f4a261; --bad:#e76f51; --card:#ffffff; --muted:#6b7a90;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--pc-bg);color:var(--pc-text);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:rgba(26,58,92,.97);backdrop-filter:blur(8px);color:#fff;border-bottom:1px solid rgba(255,255,255,.14)}
    .nav{max-width:1100px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:16px}
    .brand{font-weight:800;letter-spacing:.2px}
    .spacer{flex:1}
    .container{max-width:1100px;margin:24px auto;padding:0 18px}

    .grid{display:grid;gap:18px;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}

    .card{background:var(--card);border:1px solid #e7e9ee;border-radius:var(--radius);padding:18px;box-shadow:0 1px 4px rgba(20,30,60,.05)}
    .kpi h3{margin:0 0 6px;font-size:14px;color:var(--muted)}
    .kpi .num{font-size:28px;font-weight:800}
    .kpi small{display:block;color:var(--muted)}
    .pill{display:inline-block;border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid #e7e9ee;background:#fafbff;color:#445}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:0 0 auto}
    button, .btn{background:var(--pc-blue);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
    input[type="file"]{border:1px dashed #cfd6e5;padding:8px 10px;border-radius:10px;background:#fff}
    .muted{color:var(--muted);font-size:13px}

    footer{color:#6c7a86;text-align:center;padding:24px 12px}
    canvas{background:#fff;border-radius:var(--radius);border:1px solid #e7e9ee}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">Poulton Consultancy — Financial Dashboard</div>
      <div class="spacer"></div>
      <span class="pill" id="build-pill">BUILD: pending…</span>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h2 style="margin:0 0 8px">Data Sources</h2>
          <div class="muted">This page fetches CSVs from the repo root. Local uploads below affect <b>this browser only</b> (handy for testing; not synced).</div>
        </div>
        <div class="row">
          <label class="muted">Invoices CSV</label>
          <input id="invoicesFile" type="file" accept=".csv"/>
          <label class="muted">Costs CSV</label>
          <input id="costsFile" type="file" accept=".csv"/>
          <button id="resetBtn" title="Reload from repo files">Reload repo data</button>
        </div>
      </div>
      <div class="muted" style="margin-top:10px">
        Expected fields (case-insensitive): <code>Date</code>, <code>Currency</code>, <code>Amount</code>, <code>Status</code>, <code>Category</code> (extra columns are ignored). USD converted @ 3.67 to AED by default.
      </div>
    </section>

    <section class="grid" style="margin-top:18px">
      <div class="card kpi">
        <h3>Total Invoices (AED)</h3>
        <div class="num" id="kpiRevenue">–</div>
        <small id="kpiRevenueMeta">paid/unpaid</small>
      </div>
      <div class="card kpi">
        <h3>Total Costs (AED)</h3>
        <div class="num" id="kpiCosts">–</div>
        <small id="kpiCostsMeta">rows</small>
      </div>
      <div class="card kpi">
        <h3>Net (AED)</h3>
        <div class="num" id="kpiNet">–</div>
        <small id="kpiNetMeta">revenue - costs</small>
      </div>
    </section>

    <section class="card" style="margin-top:18px">
      <h2 style="margin:0 0 12px">Monthly Net</h2>
      <canvas id="netChart" height="120"></canvas>
    </section>
  </main>

  <footer>© Poulton Consultancy — A Name You Can Trust</footer>

  <script>
    // ======== CONFIG ========
    const BUILD = '2025-09-02-01'; // bump on each publish to force fresh fetches
    const INVOICES_URL = `./invoices_2025-09-02.csv?v=${BUILD}`;
    const COSTS_URL    = `./costs_2025-09-02.csv?v=${BUILD}`;

    // Currency map (edit as needed)
    const FX = { AED: 1, USD: 3.67 };

    // Show build in UI
    document.getElementById('build-pill').textContent = `BUILD: ${BUILD}`;

    // ======== HELPERS ========
    const toAED = (amt, cur) => {
      const k = (cur || 'AED').toUpperCase().trim();
      const fx = FX[k] ?? 1;
      const n = Number(String(amt).replace(/[, ]/g,''));
      return (isFinite(n) ? n : 0) * fx;
    };

    const parseDateKey = (d) => {
      // returns YYYY-MM
      const t = new Date(d);
      if (isNaN(t)) return 'Unknown';
      return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}`;
    };

    const csvFromURL = async (url) => {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`Failed to load ${url} (${res.status})`);
      const text = await res.text();
      return new Promise((resolve) => {
        Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          transformHeader: h => h.trim(),
          complete: ({ data }) => resolve(data)
        });
      });
    };

    const csvFromFile = (file) => new Promise((resolve, reject) => {
      Papa.parse(file, {
        header: true, skipEmptyLines: true,
        transformHeader: h => h.trim(),
        complete: ({ data }) => resolve(data),
        error: reject
      });
    });

    // ======== STATE ========
    let invoices = [];
    let costs = [];
    let chart; // Chart.js instance

    function summarise() {
      // Normalise rows
      const normInv = invoices.map(r => ({
        date: r.Date ?? r.date ?? r.DATE,
        currency: (r.Currency ?? r.currency ?? 'AED'),
        amountAED: toAED(r.Amount ?? r.amount, (r.Currency ?? r.currency)),
        status: (r.Status ?? r.status ?? '').toString().toLowerCase()
      }));

      const normCost = costs.map(r => ({
        date: r.Date ?? r.date ?? r.DATE,
        currency: (r.Currency ?? r.currency ?? 'AED'),
        amountAED: toAED(r.Amount ?? r.amount, (r.Currency ?? r.currency)),
        category: r.Category ?? r.category ?? ''
      }));

      // KPIs
      const totalRev = normInv.reduce((s,r) => s + r.amountAED, 0);
      const paidCount = normInv.filter(r => r.status.includes('success') || r.status.includes('paid')).length;
      const unpaidCount = normInv.length - paidCount;

      const totalCost = normCost.reduce((s,r) => s + r.amountAED, 0);
      const net = totalRev - totalCost;

      const money = n => n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      document.getElementById('kpiRevenue').textContent = money(totalRev);
      document.getElementById('kpiRevenueMeta').textContent = `${paidCount} paid • ${unpaidCount} unpaid • ${normInv.length} rows`;

      document.getElementById('kpiCosts').textContent = money(totalCost);
      document.getElementById('kpiCostsMeta').textContent = `${normCost.length} rows`;

      document.getElementById('kpiNet').textContent = money(net);
      document.getElementById('kpiNetMeta').textContent = net >= 0 ? 'profit' : 'loss';

      // Monthly net
      const months = new Map(); // key YYYY-MM -> {rev, cost}
      normInv.forEach(r => {
        const k = parseDateKey(r.date);
        if (!months.has(k)) months.set(k, { rev:0, cost:0 });
        months.get(k).rev += r.amountAED || 0;
      });
      normCost.forEach(r => {
        const k = parseDateKey(r.date);
        if (!months.has(k)) months.set(k, { rev:0, cost:0 });
        months.get(k).cost += r.amountAED || 0;
      });

      const keys = [...months.keys()].filter(k => k !== 'Unknown').sort();
      const netVals = keys.map(k => (months.get(k).rev - months.get(k).cost));

      // Render chart
      const ctx = document.getElementById('netChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: keys,
          datasets: [{
            label: 'Monthly Net (AED)',
            data: netVals,
            fill: false,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          elements: { line: { tension: .25 } },
          scales: { y: { ticks: { callback:v=>v.toLocaleString() } } },
          plugins: { legend: { display: true } }
        }
      });
    }

    async function loadFromRepo() {
      const [inv, cst] = await Promise.all([
        csvFromURL(INVOICES_URL),
        csvFromURL(COSTS_URL)
      ]);
      invoices = inv; costs = cst;
      summarise();
    }

    // ======== INIT & EVENTS ========
    window.addEventListener('DOMContentLoaded', async () => {
      // If there ever was a service worker, unregister it once
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
      }

      try {
        await loadFromRepo();
      } catch (e) {
        console.error(e);
        alert('Could not load CSVs from the repo.\nCheck the filenames at the top of index.html or commit the files to the repo root.');
      }

      document.getElementById('resetBtn').addEventListener('click', async () => {
        await loadFromRepo();
      });

      document.getElementById('invoicesFile').addEventListener('change', async (e) => {
        if (e.target.files?.[0]) {
          invoices = await csvFromFile(e.target.files[0]);
          summarise();
        }
      });
      document.getElementById('costsFile').addEventListener('change', async (e) => {
        if (e.target.files?.[0]) {
          costs = await csvFromFile(e.target.files[0]);
          summarise();
        }
      });
    });
  </script>
</body>
</html>
