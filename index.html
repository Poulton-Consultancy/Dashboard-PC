<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Poulton Consultancy - Financial Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
:root{
  --primary-color:#2E5C8A;--secondary-color:#4A90A4;--accent-color:#87C4A1;
  --warning-color:#F4A261;--danger-color:#E76F51;--success-color:#2A9D8F;
  --neutral-light:#F8F9FA;--neutral-dark:#343A40;
  --text-primary:#2C3E50;--text-secondary:#6C757D;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter','Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,var(--primary-color) 0%,var(--secondary-color) 100%);color:var(--text-primary);line-height:1.6;min-height:100vh}
.container{max-width:1600px;margin:0 auto;padding:20px}
.header{background:rgba(255,255,255,.98);backdrop-filter:blur(15px);border-radius:25px;padding:40px;margin-bottom:30px;box-shadow:0 25px 50px rgba(0,0,0,.1);text-align:center;border:1px solid rgba(255,255,255,.2)}
.header h1{color:var(--primary-color);font-size:3em;margin-bottom:10px;font-weight:800;letter-spacing:-.02em}
.header .tagline{color:var(--secondary-color);font-size:1.2em;margin-bottom:20px;font-weight:500}
.header .company-info{display:flex;justify-content:center;gap:30px;margin-top:20px;flex-wrap:wrap}
.company-info span{color:var(--text-secondary);font-size:.9em;display:flex;align-items:center;gap:5px}
.year-selector{display:flex;gap:15px;margin-bottom:30px;justify-content:center;flex-wrap:wrap}
.year-btn{padding:12px 25px;border:none;border-radius:30px;background:var(--neutral-light);color:var(--primary-color);cursor:pointer;font-weight:600;font-size:1em;transition:.3s;border:2px solid transparent}
.year-btn.active{background:var(--primary-color);color:#fff;transform:scale(1.05);box-shadow:0 10px 25px rgba(46,92,138,.3)}
.year-btn:hover{background:var(--secondary-color);color:#fff}
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:30px;margin-bottom:30px}
.card{background:rgba(255,255,255,.98);backdrop-filter:blur(15px);border-radius:25px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1);border:1px solid rgba(255,255,255,.2);transition:.3s;position:relative;overflow:hidden}
.card:hover{transform:translateY(-8px);box-shadow:0 30px 60px rgba(0,0,0,.15)}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--accent-color),var(--secondary-color));border-radius:25px 25px 0 0}
.card h2{color:var(--primary-color);font-size:1.5em;margin-bottom:25px;font-weight:700;display:flex;align-items:center;gap:10px}
.metric-row{display:flex;justify-content:space-between;align-items:center;padding:18px 0;border-bottom:1px solid rgba(108,117,125,.1);transition:.2s}
.metric-row:hover{background:rgba(74,144,164,.05);border-radius:8px;margin:0 -10px;padding:18px 10px}
.metric-row:last-child{border-bottom:none}
.metric-label{font-weight:500;color:var(--text-primary);font-size:1.05em}
.metric-value{font-weight:700;font-size:1.3em}
.positive{color:var(--success-color)}.negative{color:var(--danger-color)}.warning{color:var(--warning-color)}.neutral{color:var(--primary-color)}
.editable-section{background:rgba(135,196,161,.1);border:2px dashed var(--accent-color);border-radius:15px;padding:20px;margin:20px 0}
.editable-section h3{color:var(--accent-color);margin-bottom:15px;font-size:1.2em}
.input-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:15px}
.input-field{display:flex;flex-direction:column}
.input-field label{font-weight:600;color:var(--text-primary);margin-bottom:5px;font-size:.9em}
.input-field input,.input-field select,.input-field textarea{padding:12px;border:2px solid rgba(74,144,164,.2);border-radius:10px;font-size:1em;transition:border-color .2s;background:#fff}
.input-field textarea{resize:vertical;min-height:80px}
.input-field input:focus,.input-field select:focus,.input-field textarea:focus{outline:none;border-color:var(--secondary-color);box-shadow:0 0 0 3px rgba(74,144,164,.1)}
.btn{padding:12px 25px;border:none;border-radius:12px;font-weight:600;cursor:pointer;transition:.2s;font-size:1em}
.btn-primary{background:var(--primary-color);color:#fff}.btn-primary:hover{background:var(--secondary-color);transform:translateY(-2px)}
.btn-danger{background:var(--danger-color);color:#fff}.btn-danger:hover{background:#c85a3a;transform:translateY(-2px)}
.btn-success{background:var(--success-color);color:#fff}.btn-success:hover{background:#238b7a;transform:translateY(-2px)}
.btn-warning{background:var(--warning-color);color:#fff}.btn-warning:hover{background:#e8944e;transform:translateY(-2px)}
.btn-outline{background:#fff;color:var(--primary-color);border:2px solid var(--primary-color)}
.btn-outline:hover{background:var(--primary-color);color:#fff}
.invoice-table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff;border-radius:15px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,.05)}
.invoice-table th,.invoice-table td{padding:15px;text-align:left;border-bottom:1px solid rgba(108,117,125,.1)}
.invoice-table th{background:var(--neutral-light);font-weight:700;color:var(--text-primary);text-transform:uppercase;font-size:.85em;letter-spacing:.5px}
.invoice-table tbody tr:hover{background:rgba(74,144,164,.05)}
.status-badge{padding:6px 15px;border-radius:20px;font-size:.8em;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.status-paid{background:rgba(42,157,143,.15);color:var(--success-color)}
.status-unpaid{background:rgba(231,111,81,.15);color:var(--danger-color)}
.status-partially{background:rgba(244,162,97,.15);color:var(--warning-color)}
.status-licensing{background:rgba(46,92,138,.15);color:var(--primary-color)}
.status-office{background:rgba(74,144,164,.15);color:var(--secondary-color)}
.status-marketing{background:rgba(135,196,161,.15);color:var(--accent-color)}
.status-travel{background:rgba(244,162,97,.15);color:var(--warning-color)}
.status-technology{background:rgba(231,111,81,.15);color:var(--danger-color)}
.status-professional{background:rgba(42,157,143,.15);color:var(--success-color)}
.status-training{background:rgba(155,89,182,.15);color:#9b59b6}
.status-insurance{background:rgba(52,73,94,.15);color:#34495e}
.status-utilities{background:rgba(241,196,15,.15);color:#f1c40f}
.status-other{background:rgba(149,165,166,.15);color:#95a5a6}
.status-salary{background:rgba(52,152,219,.15);color:#2c7fbf}
.chart-container{position:relative;height:350px;margin-top:25px}
.full-width{grid-column:1 / -1}
.exchange-note{font-size:.9em;color:var(--text-secondary);text-align:center;margin-top:30px;font-style:italic;padding:20px;background:rgba(255,255,255,.7);border-radius:15px}
.tax-section{background:linear-gradient(135deg,rgba(46,92,138,.05),rgba(74,144,164,.05));border-radius:20px;padding:25px;margin-top:20px}
.summary-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:20px}
.summary-card{background:#fff;padding:20px;border-radius:15px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.05);border-top:4px solid}
.summary-card.revenue{border-top-color:var(--success-color)}
.summary-card.costs{border-top-color:var(--danger-color)}
.summary-card.tax{border-top-color:var(--warning-color)}
.summary-card.profit{border-top-color:var(--primary-color)}
.summary-card h4{color:var(--text-secondary);font-size:.9em;margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px}
.summary-card .amount{font-size:1.8em;font-weight:800;margin-bottom:5px;line-height:1.2}
.summary-card small{display:block;font-size:.75em;color:var(--text-secondary);margin-top:5px}
.print-button{position:fixed;bottom:30px;right:30px;background:var(--primary-color);color:#fff;border:none;border-radius:50px;padding:15px 25px;font-weight:600;cursor:pointer;box-shadow:0 10px 30px rgba(46,92,138,.3);transition:.3s}
.print-button:hover{transform:translateY(-3px);box-shadow:0 15px 40px rgba(46,92,138,.4)}
.cost-sheet-section{background:rgba(231,111,81,.1);border:2px dashed var(--danger-color);border-radius:15px;padding:20px;margin:20px 0}
.cost-sheet-section h3{color:var(--danger-color);margin-bottom:15px;font-size:1.2em}
.cost-summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:20px}
.cost-category-card{background:#fff;padding:15px;border-radius:10px;border-left:4px solid;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.cost-category-card.licensing{border-left-color:var(--primary-color)}
.cost-category-card.office{border-left-color:var(--secondary-color)}
.cost-category-card.marketing{border-left-color:var(--accent-color)}
.cost-category-card.travel{border-left-color:var(--warning-color)}
.cost-category-card.technology{border-left-color:var(--danger-color)}
.cost-category-card.professional{border-left-color:var(--success-color)}
.cost-category-card.training{border-left-color:#9b59b6}
.cost-category-card.insurance{border-left-color:#34495e}
.cost-category-card.utilities{border-left-color:#f1c40f}
.cost-category-card.other{border-left-color:#95a5a6}
.cost-category-card.salary{border-left-color:#2c7fbf}
.cost-category-card h4{font-size:.9em;color:var(--text-secondary);margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
.cost-category-card .amount{font-size:1.4em;font-weight:700;color:var(--text-primary)}
.cost-category-card .count{font-size:.8em;color:var(--text-secondary);margin-top:5px}
.wix-integration-section{background:rgba(155,89,182,.1);border:2px dashed #9b59b6;border-radius:15px;padding:20px;margin:20px 0}
.wix-integration-section h3{color:#9b59b6;margin-bottom:15px;font-size:1.2em}
.integration-status{display:flex;align-items:center;gap:10px;padding:10px 15px;border-radius:8px;margin:10px 0}
.integration-status.connected{background:rgba(42,157,143,.1);color:var(--success-color)}
.integration-status.disconnected{background:rgba(231,111,81,.1);color:var(--danger-color)}
.integration-status.pending{background:rgba(244,162,97,.1);color:var(--warning-color)}
@media print{body{background:#fff}.print-button{display:none}.year-selector{display:none}.card{box-shadow:none;border:1px solid #ddd}}
@media(max-width:768px){.dashboard-grid{grid-template-columns:1fr}.header h1{font-size:2em}.company-info{flex-direction:column;gap:10px}.input-group{grid-template-columns:1fr}.cost-summary-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Poulton Consultancy</h1>
    <div class="tagline">Leadership ‚Ä¢ Education ‚Ä¢ Excellence</div>
    <div class="company-info">
      <span>üìç Dubai, UAE (Meydan Free Zone)</span>
      <span>üìß info@poultonconsults.com</span>
      <span>üåê www.poultonconsults.com</span>
      <span>üì± +971 56 274 8890</span>
    </div>
  </div>

  <div class="card editable-section">
    <h3>üíº Business Settings (Customize Your Data)</h3>
    <div class="input-group">
      <div class="input-field"><label>UAE Tax Rate (%)</label><input type="number" id="taxRate" value="0" step="0.1" onchange="updateCalculations()"></div>
      <div class="input-field"><label>USD to AED Exchange Rate</label><input type="number" id="exchangeRate" value="3.67" step="0.01" onchange="updateCalculations()"></div>
      <div class="input-field">
        <label>Tax Year</label>
        <select id="taxYear" onchange="updateCalculations()">
          <option value="2024">2024</option><option value="2025" selected>2025</option>
          <option value="2026">2026</option><option value="2027">2027</option>
          <option value="2028">2028</option><option value="2029">2029</option>
          <option value="2030">2030</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card wix-integration-section">
    <h3>üîó Wix Site Integration</h3>
    <div class="input-group">
      <div class="input-field"><label>Wix Site URL</label><input type="url" id="wixSiteUrl" placeholder="https://yoursite.wixsite.com/mysite" onchange="saveWixSettings()"></div>
      <div class="input-field"><label>Wix API Key</label><input type="password" id="wixApiKey" placeholder="Enter your Wix API key" onchange="saveWixSettings()"></div>
      <div class="input-field">
        <label>Auto-Sync Frequency</label>
        <select id="autoSyncFreq" onchange="saveWixSettings()">
          <option value="manual">Manual Only</option><option value="hourly">Every Hour</option>
          <option value="daily">Daily</option><option value="weekly">Weekly</option>
        </select>
      </div>
    </div>
    <div class="input-group">
      <button class="btn btn-primary" onclick="testWixConnection()">Test Connection</button>
      <button class="btn btn-success" onclick="syncWithWix()">Sync Now</button>
      <button class="btn btn-warning" onclick="setupWixWebhook()">Setup Auto-Sync</button>
      <button class="btn btn-outline" onclick="seedDemo()">Load Demo Data</button>
      <button class="btn btn-danger" onclick="clearAll()">Clear All</button>
    </div>
    <div id="wixConnectionStatus" class="integration-status disconnected"><span>üî¥</span> Not Connected to Wix</div>
  </div>

  <div class="year-selector">
    <button class="year-btn active" onclick="setView('combined',event)">Combined View</button>
    <button class="year-btn" onclick="setView('2024',event)">2024</button>
    <button class="year-btn" onclick="setView('2025',event)">2025</button>
    <button class="year-btn" onclick="setView('2026',event)">2026</button>
    <button class="year-btn" onclick="setView('2027',event)">2027</button>
    <button class="year-btn" onclick="setView('2028',event)">2028</button>
    <button class="year-btn" onclick="setView('2029',event)">2029</button>
    <button class="year-btn" onclick="setView('2030',event)">2030</button>
  </div>

  <div class="summary-metrics">
    <div class="summary-card revenue"><h4>Total Revenue</h4><div class="amount positive" id="totalRevenue">AED 0</div></div>
    <div class="summary-card costs"><h4>Total Costs</h4><div class="amount negative" id="totalCosts">AED 0</div></div>
    <div class="summary-card tax"><h4>Tax Due</h4><div class="amount warning" id="totalTax">AED 0</div></div>
    <div class="summary-card profit"><h4>Net Profit</h4><div class="amount positive" id="netProfit">AED 0</div></div>
  </div>

  <div class="dashboard-grid">
    <div class="card">
      <h2>üìä Revenue Analysis</h2>
      <div id="revenueSummary">
        <div class="metric-row"><span class="metric-label">Invoices Issued</span><span class="metric-value neutral" id="totalInvoiced">0 Invoices</span></div>
        <div class="metric-row"><span class="metric-label">Payments Collected</span><span class="metric-value positive" id="totalCollected">AED 0</span></div>
        <div class="metric-row"><span class="metric-label">Outstanding Amounts</span><span class="metric-value warning" id="totalOutstanding">AED 0</span></div>
        <div class="metric-row"><span class="metric-label">Collection Rate</span><span class="metric-value positive" id="collectionRate">100%</span></div>
      </div>
    </div>

    <div class="card">
      <h2>üí± Currency Breakdown</h2>
      <div id="currencyBreakdown">
        <div class="metric-row"><span class="metric-label">USD Revenue</span><span class="metric-value positive" id="usdRevenue">$0</span></div>
        <div class="metric-row"><span class="metric-label">AED Revenue</span><span class="metric-value positive" id="aedRevenue">AED 0</span></div>
        <div class="metric-row"><span class="metric-label">USD Outstanding</span><span class="metric-value warning" id="usdOutstanding">$0</span></div>
        <div class="metric-row"><span class="metric-label">AED Outstanding</span><span class="metric-value warning" id="aedOutstanding">AED 0</span></div>
      </div>
    </div>

    <div class="card">
      <h2>üè¢ Client Portfolio</h2>
      <div id="clientAnalysis"><div class="metric-row"><span class="metric-label">No data available</span><span class="metric-value">-</span></div></div>
    </div>

    <div class="card">
      <h2>üìà Revenue Trends</h2>
      <div class="chart-container"><canvas id="monthlyChart"></canvas></div>
    </div>

    <div class="card full-width">
      <h2>üí∞ Comprehensive Cost Sheet</h2>

      <div class="cost-sheet-section">
        <h3>üìä Cost Summary by Category</h3>
        <div class="cost-summary-grid" id="costSummaryGrid"></div>
      </div>

      <div class="editable-section">
        <h3>‚ûï Add New Cost/Expense</h3>
        <div class="input-group">
          <div class="input-field"><label>Description *</label><input type="text" id="newCostDesc" placeholder="e.g., Office Rent, Software License, Travel Expense"></div>
          <div class="input-field"><label>Date *</label><input type="date" id="newCostDate"></div>
          <div class="input-field"><label>Amount *</label><input type="number" id="newCostAmount" placeholder="0.00" step="0.01"></div>
          <div class="input-field"><label>Currency</label><select id="newCostCurrency"><option value="AED">AED</option><option value="USD">USD</option></select></div>
          <div class="input-field"><label>Category</label>
            <select id="newCostCategory">
              <option value="Licensing">Licensing & Renewals</option>
              <option value="Office">Office Expenses</option>
              <option value="Marketing">Marketing & Advertising</option>
              <option value="Travel">Travel & Transport</option>
              <option value="Technology">Technology & Software</option>
              <option value="Professional">Professional Services</option>
              <option value="Training">Training & Development</option>
              <option value="Insurance">Insurance</option>
              <option value="Utilities">Utilities</option>
              <option value="Salary">Salary</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="input-field"><label>Tax Deductible</label><select id="newCostDeductible"><option value="true">Yes</option><option value="false">No</option></select></div>
        </div>
        <div class="input-group">
          <div class="input-field" style="grid-column:1 / -1;"><label>Notes (Optional)</label><textarea id="newCostNotes" placeholder="Additional notes about this expense..."></textarea></div>
        </div>
        <div class="input-group">
          <button class="btn btn-primary" onclick="addNewCost()">Add Cost</button>
          <button class="btn btn-warning" onclick="addRecurringCost()">Add as Recurring</button>
          <button class="btn btn-success" onclick="importCostsFromFile()">Import from File</button>
          <button class="btn btn-outline" onclick="exportCostsCSV()">Download Costs (CSV)</button>
        </div>
      </div>

      <table class="invoice-table" id="costTable">
        <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th>Tax Deductible</th><th>Notes</th><th>Actions</th></tr></thead>
        <tbody id="costTableBody"></tbody>
      </table>

      <div class="summary-metrics" style="margin-top:25px;">
        <div class="summary-card costs"><h4>Total Expenses</h4><div class="amount negative" id="totalExpenses">AED 0</div></div>
        <div class="summary-card tax"><h4>Tax Deductible</h4><div class="amount warning" id="deductibleTotal">AED 0</div></div>
        <div class="summary-card costs"><h4>Non-Deductible</h4><div class="amount negative" id="nonDeductibleTotal">AED 0</div></div>
        <div class="summary-card profit"><h4>Monthly Average</h4><div class="amount neutral" id="monthlyAverage">AED 0</div></div>
      </div>
    </div>

    <div class="card full-width">
      <h2>üìã Invoice Management</h2>
      <div class="editable-section">
        <h3>‚ûï Add New Invoice Manually</h3>
        <div class="input-group">
          <div class="input-field"><label>Invoice Number</label><input type="text" id="newInvoiceNum" placeholder="e.g., 32"></div>
          <div class="input-field"><label>Date</label><input type="date" id="newInvoiceDate"></div>
          <div class="input-field"><label>Client Name</label><input type="text" id="newInvoiceClient" placeholder="Client Name"></div>
          <div class="input-field"><label>Amount</label><input type="number" id="newInvoiceAmount" placeholder="0.00" step="0.01"></div>
          <div class="input-field"><label>Currency</label><select id="newInvoiceCurrency"><option value="AED">AED</option><option value="USD">USD</option></select></div>
          <div class="input-field"><label>Status</label>
            <select id="newInvoiceStatus"><option value="Unpaid">Unpaid</option><option value="Paid">Paid</option><option value="Partially Paid">Partially Paid</option></select></div>
        </div>
        <div class="input-group">
          <button class="btn btn-primary" onclick="addNewInvoice()">Add Invoice</button>
          <button class="btn btn-outline" onclick="exportInvoicesCSV()">Download Invoices (CSV)</button>
          <button class="btn btn-success" onclick="importInvoicesFromFile()">Import from File</button>
        </div>
      </div>

      <table class="invoice-table" id="invoiceTable">
        <thead><tr><th>Invoice #</th><th>Date</th><th>Client</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="invoiceTableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="exchange-note">
    üí° <strong>Note:</strong> All amounts are calculated using the current exchange rate.
    USD amounts are converted to AED for summary calculations. Data is saved locally (in your browser) and can sync with your Wix site. When you visit with <code>?live=1</code>, the page also reads <code>invoices.csv</code> and <code>costs.csv</code> from the repo and **merges** them into your current data.
  </div>
</div>

<button class="print-button" onclick="window.print()">üñ®Ô∏è Print Dashboard</button>

<script>
/* ---------- Data model (no seeds) ---------- */
let financialData = {
  invoices: [],
  expenses: [],
  missingInvoices: [],
  wixSettings: { siteUrl:'', apiKey:'', autoSyncFreq:'manual', lastSync:null, connected:false }
};
let currentView = 'combined';

/* ---------- Settings & helpers ---------- */
function getSettings(){
  return {
    taxRate: parseFloat(document.getElementById('taxRate').value)||0,
    exchangeRate: parseFloat(document.getElementById('exchangeRate').value)||3.67,
    taxYear: document.getElementById('taxYear').value || '2025'
  };
}
function toFixed2(n){return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});}
function convertToAED(amount,currency){ const s=getSettings(); return (currency||'AED').toUpperCase()==='USD' ? amount*s.exchangeRate : amount; }
function formatCurrency(amount,currency='AED'){ return (currency||'AED').toUpperCase()==='USD' ? `$${toFixed2(amount)}` : `AED ${toFixed2(amount)}`; }
function getYearFromDate(d){ const dt=new Date(d); return isFinite(dt)? dt.getFullYear(): NaN; }

/* ---------- CSV parsing helpers ---------- */
function detectDelimiter(sample){const cand=[',',';','\t'];const top=String(sample||'').split('\n',10).join('\n');const counts=cand.map(d=>(top.match(new RegExp(d,'g'))||[]).length);return cand[counts.indexOf(Math.max(...counts))]||',';}
function stripBOM(s){s=String(s||'');return s.charCodeAt(0)===0xFEFF?s.slice(1):s;}
function parseCSV(text){
  text=stripBOM(String(text||''));const delim=detectDelimiter(text);const rows=[];let i=0,cur='',q=false,row=[];
  while(i<text.length){const c=text[i++];if(c==='\"'){if(q&&text[i]==='\"'){cur+='\"';i++;}else{q=!q}}
  else if(c===delim&&!q){row.push(cur);cur='';}
  else if((c==='\n'||c==='\r')&&!q){if(cur.length||row.length){row.push(cur);rows.push(row);row=[];cur='';}}
  else{cur+=c}}
  if(cur.length||row.length){row.push(cur);rows.push(row)}return rows;
}
function normalizeObjects(rows){
  if(!rows.length) return [];
  const header=rows[0].map(h=>(h||'').trim());
  const ok=header.some(h=>/date|amount|currency|client|invoice|description|category|status|paid/i.test(h));
  if(ok){return rows.slice(1).filter(r=>r.some(c=>String(c).trim()!=='')).map(r=>{const o={};header.forEach((h,i)=>o[h]=(r[i]??'').toString().trim());return o;});}
  return rows.filter(r=>r.some(c=>String(c).trim()!=='')).map(r=>({0:(r[0]||'').trim(),1:(r[1]||'').trim(),2:(r[2]||'').trim(),3:(r[3]||'').trim(),4:(r[4]||'').trim(),5:(r[5]||'').trim(),6:(r[6]||'').trim()}));
}
function toISODateFlexible(d){
  if(!d) return new Date().toISOString().slice(0,10);
  const s=String(d).trim(); if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const m=s.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/);
  if(m){let [_,a,b,c]=m;a=+a;b=+b;c=+c;if(c<100)c+=2000;const dd=a>12?a:b;const mm=a>12?b:a;return `${c}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;}
  const t=new Date(s);return isFinite(t)?t.toISOString().slice(0,10):new Date().toISOString().slice(0,10);
}

/* ---------- Normalizers ---------- */
function normalizeInvoice(o){
  const num = s => Number(String(s||'0').replace(/[^0-9.-]/g,''))||0;
  return {
    num: o.num || o['Invoice #'] || o.invoice || o[0] || '',
    date: toISODateFlexible(o.date || o.Date || o[1]),
    client: o.client || o.Client || o[2] || '',
    amount: num(o.amount || o.Amount || o[3]),
    currency: (o.currency || o.Currency || o[4] || 'AED').toUpperCase(),
    status: o.status || o.Status || o[5] || 'Unpaid',
    paidAmount: num(o.paidAmount || o['Paid Amount'] || o[6] || 0)
  };
}
function normalizeCostRecord(v){
  const num = s => Number(String(s||'0').replace(/[^0-9.-]/g,''))||0;
  return {
    id:'cost_'+Date.now()+'_'+Math.random().toString(36).slice(2),
    description: v.description || v.Description || v[1] || 'Expense',
    date: toISODateFlexible(v.date || v.Date || v[0]),
    category: v.category || v.Category || v[2] || 'Other',
    amount: num(v.amount || v.Amount || v[3]),
    currency: (v.currency || v.Currency || v[4] || 'AED').toUpperCase(),
    deductible: String(v['Tax Deductible'] || v.deductible || v[5] || '').toLowerCase().startsWith('y'),
    notes: v.notes || v.Notes || v[6] || ''
  };
}

/* ---------- Dedup helpers ---------- */
const invoiceKey = inv => String(inv.num||'').trim().toUpperCase();
const costKey = c => [ (c.date||'').slice(0,10), String(c.description||'').trim().toUpperCase(), Number(c.amount||0).toFixed(2), (c.currency||'AED').toUpperCase() ].join('|');
function mergeInvoices(existing,incoming){const map=new Map(existing.map(i=>[invoiceKey(i),i]));const duplicates=[];incoming.forEach(i=>{const k=invoiceKey(i);if(!k)return; if(map.has(k))duplicates.push(k);else map.set(k,i)});return{merged:[...map.values()],duplicates};}
function mergeCosts(existing,incoming){const map=new Map(existing.map(c=>[costKey(c),c]));const duplicates=[];incoming.forEach(c=>{const k=costKey(c);if(map.has(k))duplicates.push(k);else map.set(k,c)});return{merged:[...map.values()],duplicates};}

/* ---------- UI rendering ---------- */
function statusToClass(status){const s=String(status||'').toLowerCase();if(s.includes('partial'))return'status-partially';if(s.includes('paid'))return'status-paid';return'status-unpaid';}
function updateInvoiceTable(invoices){
  const tbody=document.getElementById('invoiceTableBody');tbody.innerHTML='';
  invoices.forEach(inv=>{
    const row=tbody.insertRow();
    row.innerHTML=`
      <td><strong>#${inv.num}</strong></td>
      <td>${new Date(inv.date).toLocaleDateString()}</td>
      <td><strong>${inv.client}</strong></td>
      <td><strong>${formatCurrency(inv.amount,inv.currency)}</strong></td>
      <td><span class="status-badge ${statusToClass(inv.status)}">${inv.status}</span></td>
      <td><button class="btn btn-danger" onclick="removeInvoice('${inv.num}')">Remove</button></td>`;
  });
}
function updateCostTable(expenses){
  const tbody=document.getElementById('costTableBody');tbody.innerHTML='';
  expenses.forEach(exp=>{
    const row=tbody.insertRow();
    row.innerHTML=`
      <td>${new Date(exp.date).toLocaleDateString()}</td>
      <td><strong>${exp.description}</strong></td>
      <td><span class="status-badge status-${(exp.category||'other').toLowerCase()}">${exp.category}</span></td>
      <td><strong>${formatCurrency(exp.amount,exp.currency)}</strong></td>
      <td><span class="status-badge ${exp.deductible?'status-paid':'status-unpaid'}">${exp.deductible?'Yes':'No'}</span></td>
      <td>${exp.notes||'-'}</td>
      <td><button class="btn btn-danger" onclick="removeCost('${exp.id}')">Remove</button></td>`;
  });
}
function updateCostSummaryGrid(expenses){
  const grid=document.getElementById('costSummaryGrid');const cats={};['Licensing','Office','Marketing','Travel','Technology','Professional','Training','Insurance','Utilities','Salary','Other'].forEach(c=>cats[c]={total:0,count:0});
  expenses.forEach(exp=>{const aed=convertToAED(Number(exp.amount)||0,exp.currency);const cat=cats[exp.category]?exp.category:'Other';cats[cat].total+=aed;cats[cat].count+=1;});
  grid.innerHTML=Object.entries(cats).map(([category,data])=>`
    <div class="cost-category-card ${category.toLowerCase()}">
      <h4>${category}</h4>
      <div class="amount">AED ${toFixed2(data.total)}</div>
      <div class="count">${data.count} expense${data.count!==1?'s':''}</div>
    </div>`).join('');
}

/* ---------- CRUD & Import/Export ---------- */
function addNewInvoice(){
  const num=document.getElementById('newInvoiceNum').value.trim();
  const date=document.getElementById('newInvoiceDate').value;
  const client=document.getElementById('newInvoiceClient').value.trim();
  const amount=parseFloat(document.getElementById('newInvoiceAmount').value);
  const currency=document.getElementById('newInvoiceCurrency').value;
  const status=document.getElementById('newInvoiceStatus').value;
  if(!num||!date||!client||isNaN(amount)){alert('Please fill in all required fields');return;}
  if(financialData.invoices.some(i=>invoiceKey(i)===num.toUpperCase())){alert(`Duplicate invoice #${num} ‚Äì not added.`);return;}
  financialData.invoices.push({num,date,client,amount,currency,status,paidAmount:status.toLowerCase().includes('paid')?amount:0});
  document.getElementById('newInvoiceNum').value='';document.getElementById('newInvoiceDate').value='';document.getElementById('newInvoiceClient').value='';document.getElementById('newInvoiceAmount').value='';
  saveData();updateDashboard();if(financialData.wixSettings.autoSyncFreq!=='manual')syncWithWix();
}
function addNewCost(){
  const description=document.getElementById('newCostDesc').value;
  const date=document.getElementById('newCostDate').value;
  const amount=parseFloat(document.getElementById('newCostAmount').value);
  const currency=document.getElementById('newCostCurrency').value;
  const category=document.getElementById('newCostCategory').value;
  const deductible=document.getElementById('newCostDeductible').value==='true';
  const notes=document.getElementById('newCostNotes').value;
  if(!description||!date||isNaN(amount)){alert('Please fill in all required fields (Description, Date, Amount)');return;}
  const newCost={id:'cost_'+Date.now(),description,date,amount,currency,category,deductible,notes,recurring:false};
  financialData.expenses.push(newCost);
  document.getElementById('newCostDesc').value='';document.getElementById('newCostDate').value='';document.getElementById('newCostAmount').value='';document.getElementById('newCostNotes').value='';
  saveData();updateDashboard();if(financialData.wixSettings.autoSyncFreq!=='manual')syncWithWix();alert('‚úÖ Cost added successfully!');
}
function addRecurringCost(){
  const description=document.getElementById('newCostDesc').value;
  const date=document.getElementById('newCostDate').value;
  const amount=parseFloat(document.getElementById('newCostAmount').value);
  const currency=document.getElementById('newCostCurrency').value;
  const category=document.getElementById('newCostCategory').value;
  const deductible=document.getElementById('newCostDeductible').value==='true';
  const notes=document.getElementById('newCostNotes').value;
  if(!description||!date||isNaN(amount)){alert('Please fill in all required fields (Description, Date, Amount)');return;}
  const frequency=prompt('How often should this cost recur?\n1. Monthly\n2. Quarterly\n3. Yearly\n\nEnter 1, 2, or 3:','1'); if(!frequency||!['1','2','3'].includes(frequency)){alert('Invalid frequency selected');return;}
  const map={'1':'monthly','2':'quarterly','3':'yearly'};const selected=map[frequency];
  const newCost={id:'cost_'+Date.now(),description:description+` (${selected})`,date,amount,currency,category,deductible,notes:(notes||'')+` | Recurring: ${selected}`,recurring:true,frequency:selected};
  financialData.expenses.push(newCost);
  document.getElementById('newCostDesc').value='';document.getElementById('newCostDate').value='';document.getElementById('newCostAmount').value='';document.getElementById('newCostNotes').value='';
  saveData();updateDashboard();alert(`‚úÖ Recurring ${selected} cost added successfully!`);
}
function removeInvoice(num){if(confirm(`Remove Invoice #${num}?`)){financialData.invoices=financialData.invoices.filter(inv=>inv.num!==num);saveData();updateDashboard();}}
function removeCost(id){const cost=(financialData.expenses||[]).find(e=>e.id===id);if(confirm(`Remove "${cost?.description||'this cost'}"?`)){financialData.expenses=(financialData.expenses||[]).filter(e=>e.id!==id);saveData();updateDashboard();}}
function downloadCSV(filename,rows){const csv=rows.map(r=>r.map(cell=>{const s=(cell??'').toString();return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;}).join(',')).join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}
function exportCostsCSV(){const header=["Date","Description","Category","Amount","Currency","Tax Deductible","Notes"];const rows=(financialData.expenses||[]).map(c=>[c.date||"",c.description||"",c.category||"",c.amount!=null?c.amount:"",c.currency||"AED",c.deductible?"Yes":"No",c.notes||""]);downloadCSV('costs.csv',[header,...rows]);}
function exportInvoicesCSV(){const header=["Invoice #","Date","Client","Amount","Currency","Status","Paid Amount"];const rows=(financialData.invoices||[]).map(i=>[i.num||"",i.date||"",i.client||"",i.amount!=null?i.amount:"",i.currency||"AED",i.status||"Unpaid",i.paidAmount!=null?i.paidAmount:""]);downloadCSV('invoices.csv',[header,...rows]);}
function importInvoicesFromFile(){
  const input=document.createElement('input');input.type='file';input.accept='.csv,.json';
  input.onchange=ev=>{
    const file=ev.target.files[0];if(!file)return;const reader=new FileReader();
    reader.onload=e=>{
      try{
        const raw=stripBOM(e.target.result);let imported=[];
        if(file.name.endsWith('.json')){const arr=JSON.parse(raw);imported=(Array.isArray(arr)?arr:[]).map(normalizeInvoice);}
        else{const rows=parseCSV(raw);const objs=normalizeObjects(rows);imported=objs.map(normalizeInvoice);}
        if(imported.length){
          const {merged,duplicates}=mergeInvoices(financialData.invoices||[],imported);
          financialData.invoices=merged;saveData();updateDashboard();
          alert(`‚úÖ Imported ${imported.length-duplicates.length} invoices`+(duplicates.length?`\n‚ö†Ô∏è Skipped ${duplicates.length} duplicate(s).`:''));
        }else alert('‚ùå No valid invoices found in the file');
      }catch(err){alert('‚ùå Error importing invoices: '+err.message);}
    };reader.readAsText(file);
  };input.click();
}
function importCostsFromFile(){
  const input=document.createElement('input');input.type='file';input.accept='.csv,.json';
  input.onchange=ev=>{
    const file=ev.target.files[0];if(!file)return;const reader=new FileReader();
    reader.onload=e=>{
      try{
        const raw=stripBOM(e.target.result);let imported=[];
        if(file.name.endsWith('.json')){const arr=JSON.parse(raw);imported=(Array.isArray(arr)?arr:[]).map(normalizeCostRecord);}
        else{const rows=parseCSV(raw);const objs=normalizeObjects(rows);imported=objs.map(normalizeCostRecord);}
        if(imported.length){
          const {merged,duplicates}=mergeCosts(financialData.expenses||[],imported);
          financialData.expenses=merged;saveData();updateDashboard();
          alert(`‚úÖ Imported ${imported.length-duplicates.length} costs`+(duplicates.length?`\n‚ö†Ô∏è Skipped ${duplicates.length} duplicate(s).`:''));
        }else alert('‚ùå No valid costs found in the file');
      }catch(err){alert('‚ùå Error importing costs: '+err.message);}
    };reader.readAsText(file);
  };input.click();
}

/* ---------- Wix & app state ---------- */
function saveWixSettings(){
  financialData.wixSettings={siteUrl:document.getElementById('wixSiteUrl').value,apiKey:document.getElementById('wixApiKey').value,autoSyncFreq:document.getElementById('autoSyncFreq').value,lastSync:financialData.wixSettings.lastSync,connected:financialData.wixSettings.connected};
  saveData();
}
function updateWixConnectionStatus(){
  const statusDiv=document.getElementById('wixConnectionStatus');
  if(financialData.wixSettings.connected){
    statusDiv.className='integration-status connected';
    statusDiv.innerHTML='<span>üü¢</span> Connected to Wix - Last sync: '+(financialData.wixSettings.lastSync?new Date(financialData.wixSettings.lastSync).toLocaleString():'Never');
  }else if(financialData.wixSettings.siteUrl&&financialData.wixSettings.apiKey){
    statusDiv.className='integration-status pending';
    statusDiv.innerHTML='<span>üü°</span> Ready to Connect - Click "Test Connection"';
  }else{
    statusDiv.className='integration-status disconnected';
    statusDiv.innerHTML='<span>üî¥</span> Not Connected to Wix';
  }
}
function testWixConnection(){
  const siteUrl=document.getElementById('wixSiteUrl').value;const apiKey=document.getElementById('wixApiKey').value;
  if(!siteUrl||!apiKey){alert('Please enter both Wix Site URL and API Key');return;}
  const statusDiv=document.getElementById('wixConnectionStatus');statusDiv.className='integration-status pending';statusDiv.innerHTML='<span>üü°</span> Testing connection...';
  setTimeout(()=>{financialData.wixSettings.connected=true;financialData.wixSettings.lastSync=new Date().toISOString();saveData();updateWixConnectionStatus();alert('‚úÖ Successfully connected to Wix!\n\n(Stub for real API.)');},1500);
}
function syncWithWix(){
  if(!financialData.wixSettings.connected){alert('Please connect to Wix first');return;}
  const statusDiv=document.getElementById('wixConnectionStatus');statusDiv.className='integration-status pending';statusDiv.innerHTML='<span>üü°</span> Syncing with Wix...';
  setTimeout(()=>{financialData.wixSettings.lastSync=new Date().toISOString();saveData();updateWixConnectionStatus();alert('‚úÖ Data synced with Wix!\n\n(Stub for real API.)');},2000);
}
function setupWixWebhook(){if(!financialData.wixSettings.connected){alert('Please connect to Wix first');return;}alert('üîß Webhook Setup (demo)\nAuto-import invoices, expense tracking, and backups can be wired here.');}

/* ---------- Dashboard totals & chart ---------- */
function setView(view,evt){currentView=view;document.querySelectorAll('.year-btn').forEach(b=>b.classList.remove('active'));if(evt&&evt.target)evt.target.classList.add('active');updateDashboard();}
function saveData(){localStorage.setItem('poultonFinancialData',JSON.stringify(financialData));localStorage.setItem('poultonSettings',JSON.stringify(getSettings()));}
function loadSavedData(){
  const saved=localStorage.getItem('poultonFinancialData');if(saved)financialData=JSON.parse(saved);
  const savedSettings=localStorage.getItem('poultonSettings');
  if(savedSettings){const s=JSON.parse(savedSettings);document.getElementById('taxRate').value=s.taxRate??0;document.getElementById('exchangeRate').value=s.exchangeRate??3.67;document.getElementById('taxYear').value=s.taxYear??'2025';}
  if(financialData.wixSettings){document.getElementById('wixSiteUrl').value=financialData.wixSettings.siteUrl||'';document.getElementById('wixApiKey').value=financialData.wixSettings.apiKey||'';document.getElementById('autoSyncFreq').value=financialData.wixSettings.autoSyncFreq||'manual';updateWixConnectionStatus();}
}
function updateDashboard(){
  const settings=getSettings();
  let invoices=financialData.invoices||[], missing=financialData.missingInvoices||[], expenses=financialData.expenses||[];
  if(currentView!=='combined'){const y=parseInt(currentView);invoices=invoices.filter(i=>getYearFromDate(i.date)===y);missing=missing.filter(i=>getYearFromDate(i.date)===y);expenses=expenses.filter(e=>getYearFromDate(e.date)===y);}
  let usdInv=0,aedInv=0,usdPaid=0,aedPaid=0,usdOut=0,aedOut=0;
  invoices.forEach(i=>{if(i.currency==='USD'){usdInv+=i.amount;usdPaid+=(i.paidAmount||0);usdOut+=(i.amount-(i.paidAmount||0));}else{aedInv+=i.amount;aedPaid+=(i.paidAmount||0);aedOut+=(i.amount-(i.paidAmount||0));}});
  missing.forEach(i=>{if(i.currency==='USD')usdPaid+=i.amount;else aedPaid+=i.amount;});
  const totalCollected=convertToAED(usdPaid,'USD')+aedPaid;
  const totalOutstanding=convertToAED(usdOut,'USD')+aedOut;
  const totalInvoiced=convertToAED(usdInv,'USD')+aedInv;
  const collectionRate=totalInvoiced>0?((totalCollected/(totalCollected+totalOutstanding))*100):100;

  let totalExpenses=0,deductible=0,nonDeductible=0;
  expenses.forEach(e=>{const aed=convertToAED(e.amount,e.currency);totalExpenses+=aed;e.deductible?deductible+=aed:nonDeductible+=aed;});
  const monthlyAverage=totalExpenses/12;
  const taxableProfit=totalCollected-deductible;
  const estimatedTax=Math.max(0,taxableProfit*(settings.taxRate/100));
  const netProfit=taxableProfit-estimatedTax;

  document.getElementById('totalRevenue').innerHTML=`<div class="amount positive">${formatCurrency(totalCollected)}</div><small style="opacity:.8;font-size:.8em;">USD ${usdPaid.toLocaleString()} + AED ${aedPaid.toLocaleString()}</small>`;
  document.getElementById('totalCosts').textContent=formatCurrency(totalExpenses);
  document.getElementById('totalTax').textContent=formatCurrency(estimatedTax);
  document.getElementById('netProfit').textContent=formatCurrency(netProfit);
  document.getElementById('totalInvoiced').innerHTML=`<div>${(invoices.length+missing.length)} Invoices</div><small style="opacity:.8;">USD ${usdInv.toLocaleString()} + AED ${aedInv.toLocaleString()}</small>`;
  document.getElementById('totalCollected').innerHTML=`<div>${formatCurrency(totalCollected)}</div><small style="opacity:.8;">USD ${usdPaid.toLocaleString()} + AED ${aedPaid.toLocaleString()}</small>`;
  document.getElementById('totalOutstanding').innerHTML=`<div>${formatCurrency(totalOutstanding)}</div><small style="opacity:.8;">USD ${usdOut.toLocaleString()} + AED ${aedOut.toLocaleString()}</small>`;
  document.getElementById('collectionRate').textContent=`${collectionRate.toFixed(1)}%`;
  document.getElementById('usdRevenue').textContent=`$${usdPaid.toLocaleString()}`;
  document.getElementById('aedRevenue').textContent=`AED ${aedPaid.toLocaleString()}`;
  document.getElementById('usdOutstanding').textContent=`$${usdOut.toLocaleString()}`;
  document.getElementById('aedOutstanding').textContent=`AED ${aedOut.toLocaleString()}`;
  document.getElementById('totalExpenses').textContent=formatCurrency(totalExpenses);
  document.getElementById('deductibleTotal').textContent=formatCurrency(deductible);
  document.getElementById('nonDeductibleTotal').textContent=formatCurrency(nonDeductible);
  document.getElementById('monthlyAverage').textContent=formatCurrency(monthlyAverage);

  const clientTotals={};let totalClient=0;
  [...invoices,...missing].forEach(i=>{const aed=convertToAED(i.amount||i.paidAmount||0,i.currency);totalClient+=aed;if(!clientTotals[i.client])clientTotals[i.client]={USD:0,AED:0};clientTotals[i.client][i.currency]+= (i.amount||i.paidAmount||0);});
  const sorted=Object.entries(clientTotals).map(([client,cur])=>{const aedTot=convertToAED(cur.USD,'USD')+cur.AED;return [client,cur,aedTot];}).sort((a,b)=>b[2]-a[2]).slice(0,5);
  const clientHTML=sorted.map(([client,cur,aedTot])=>{const pct=totalClient>0?((aedTot/totalClient)*100).toFixed(1):0;const label=client.length>25?client.substring(0,25)+'...':client;return `<div class="metric-row"><span class="metric-label">${label}</span><span class="metric-value">${formatCurrency(aedTot)} (${pct}%)</span></div>`;}).join('');
  document.getElementById('clientAnalysis').innerHTML=clientHTML||`<div class="metric-row"><span class="metric-label">No data available</span><span class="metric-value">-</span></div>`;

  updateInvoiceTable(invoices);updateCostTable(expenses);updateCostSummaryGrid(expenses);updateChart(invoices);updateWixConnectionStatus();
}
function updateChart(invoices){
  const ctx=document.getElementById('monthlyChart').getContext('2d');if(window.monthlyChart)window.monthlyChart.destroy();
  const monthly={};invoices.forEach(i=>{const d=new Date(i.date);const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;if(!monthly[key])monthly[key]={invoiced:0,collected:0};monthly[key].invoiced+=convertToAED(i.amount,i.currency);monthly[key].collected+=convertToAED(i.paidAmount||0,i.currency);});
  const keys=Object.keys(monthly).sort();const labels=keys.map(k=>{const [y,m]=k.split('-');return new Date(y,m-1).toLocaleDateString('en-US',{month:'short',year:'numeric'});});
  const invoiced=keys.map(k=>monthly[k].invoiced);const collected=keys.map(k=>monthly[k].collected);
  window.monthlyChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Invoiced',data:invoiced,borderColor:'#4A90A4',backgroundColor:'rgba(74,144,164,0.1)',tension:0.4,fill:true},{label:'Collected',data:collected,borderColor:'#2A9D8F',backgroundColor:'rgba(42,157,143,0.1)',tension:0.4,fill:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:20,font:{weight:600}}}},scales:{x:{grid:{display:false},ticks:{font:{weight:500}}},y:{beginAtZero:true,grid:{color:'rgba(0,0,0,0.05)'},ticks:{callback:v=>'AED '+Number(v).toLocaleString(),font:{weight:500}}}},interaction:{intersect:false,mode:'index'}}});
}

/* ---------- Quick utils ---------- */
function seedDemo(){
  const today=new Date().toISOString().split('T')[0];
  const demo=[{description:'Office Rent',date:today,amount:4500,currency:'AED',category:'Office',deductible:true,notes:'Business Bay'},{description:'Adobe CC',date:today,amount:54.99,currency:'USD',category:'Technology',deductible:true,notes:'Monthly'},{description:'Marketing Campaign',date:today,amount:2200,currency:'AED',category:'Marketing',deductible:true,notes:'Q3 push'},{description:'Consultant Salary',date:today,amount:12000,currency:'AED',category:'Salary',deductible:true,notes:'Monthly payroll'}].map(e=>({id:'cost_'+Date.now()+'_'+Math.random().toString(36).slice(2),...e}));
  financialData.expenses.push(...demo);saveData();updateDashboard();alert('‚úÖ Demo expenses loaded.');
}
function clearAll(){
  if(!confirm('This will clear all locally saved invoices, expenses, and settings. Continue?'))return;
  localStorage.removeItem('poultonFinancialData');localStorage.removeItem('poultonSettings');
  financialData={invoices:[],expenses:[],missingInvoices:[],wixSettings:{siteUrl:'',apiKey:'',autoSyncFreq:'manual',lastSync:null,connected:false}};
  document.getElementById('taxRate').value=0;document.getElementById('exchangeRate').value=3.67;document.getElementById('taxYear').value='2025';
  document.getElementById('wixSiteUrl').value='';document.getElementById('wixApiKey').value='';document.getElementById('autoSyncFreq').value='manual';
  updateDashboard();alert('üßπ Cleared. Fresh start.');
}
function updateCalculations(){saveData();updateDashboard();}

/* ---------- Init ---------- */
loadSavedData();updateDashboard();setInterval(saveData,30000);
document.getElementById('newCostDate').value=new Date().toISOString().split('T')[0];
document.getElementById('newInvoiceDate').value=new Date().toISOString().split('T')[0];
</script>

<!-- ===== Wix API Loader: pull invoices/costs from your Wix site ===== -->
<script>
/**
 * We‚Äôll call your Wix HTTP functions using the values you already input in the
 * ‚ÄúWix Site Integration‚Äù card (siteUrl + apiKey). Nothing is hard-coded.
 * - Click ‚ÄúTest Connection‚Äù to save settings.
 * - Press ‚ÄúSync Now‚Äù to fetch fresh data from Wix immediately.
 */

function wixBaseUrl() {
  try {
    const siteUrl = (financialData?.wixSettings?.siteUrl || '').trim();
    if (!siteUrl) return null;
    const u = new URL(siteUrl);
    return `${u.origin}/_functions`;
  } catch (_) {
    return null;
  }
}

async function wixFetchJSON(path) {
  const base = wixBaseUrl();
  const key  = (financialData?.wixSettings?.apiKey || '').trim();

  if (!base || !key) {
    throw new Error('Missing Wix Site URL or API Key (set in the Integration section).');
  }

  const res = await fetch(`${base}/${path}`, {
    headers: { 'Authorization': `Bearer ${key}` },
    cache: 'no-store',
  });

  if (!res.ok) {
    const t = await res.text().catch(()=>'');
    throw new Error(`Wix API error ${res.status}: ${t}`);
  }
  return res.json();
}

/** Robust normalizers (map your Wix fields to the dashboard shape) */
function normalizeInvoiceFromWix(o) {
  const n = s => Number(String(s ?? '0').replace(/[^0-9.-]/g, '')) || 0;
  return {
    num:       o.num || o.number || o.invoiceNumber || o['Invoice #'] || o._id || '',
    date:      o.date || o.invoiceDate || o.createdAt || o.Date || '',
    client:    o.client || o.clientName || o.customer || o.Client || '',
    amount:    n(o.amount || o.Amount),
    currency:  (o.currency || o.Currency || 'AED').toUpperCase(),
    status:    o.status || o.Status || 'Unpaid',
    paidAmount:n(o.paidAmount || o['Paid Amount'] || (String(o.status||'').match(/paid|success|cleared|complete/i) ? (o.amount||0) : 0))
  };
}

function normalizeCostFromWix(o) {
  const n = s => Number(String(s ?? '0').replace(/[^0-9.-]/g, '')) || 0;
  return {
    id:         o._id || ('cost_'+Date.now()+'_'+Math.random().toString(36).slice(2)),
    description:o.description || o.desc || o.Description || 'Expense',
    date:       o.date || o.Date || '',
    category:   o.category || o.Category || 'Other',
    amount:     n(o.amount || o.Amount),
    currency:   (o.currency || o.Currency || 'AED').toUpperCase(),
    deductible: String(o.deductible ?? o['Tax Deductible'] ?? '').toLowerCase().startsWith('y'),
    notes:      o.notes || o.Notes || ''
  };
}

/** De-dupe helpers: key on (num|date|amount) for invoices, (desc|date|amount) for costs */
function dedupeInvoices(list) {
  const map = new Map();
  list.forEach(inv => {
    const k = [inv.num||'', inv.date||'', Number(inv.amount)||0].join('|');
    if (!map.has(k)) map.set(k, inv);
  });
  return [...map.values()];
}

function dedupeCosts(list) {
  const map = new Map();
  list.forEach(c => {
    const k = [String(c.description||'').toLowerCase(), c.date||'', Number(c.amount)||0].join('|');
    if (!map.has(k)) map.set(k, c);
  });
  return [...map.values()];
}

/** Load from Wix and merge (with dedupe) */
async function loadFromWixAndMerge() {
  const statusDiv = document.getElementById('wixConnectionStatus');
  try {
    if (statusDiv) {
      statusDiv.className = 'integration-status pending';
      statusDiv.innerHTML = '<span>üü°</span> Fetching from Wix...';
    }

    const [invResp, costResp] = await Promise.all([
      wixFetchJSON('invoices'),
      wixFetchJSON('costs'),
    ]);

    const wixInvoices = (invResp?.items || []).map(normalizeInvoiceFromWix);
    const wixCosts    = (costResp?.items || []).map(normalizeCostFromWix);

    // Merge with any locally saved/added items (manual entries or imported CSVs)
    const localInv = Array.isArray(financialData.invoices) ? financialData.invoices : [];
    const localExp = Array.isArray(financialData.expenses) ? financialData.expenses : [];

    const mergedInv = dedupeInvoices([...wixInvoices, ...localInv]);
    const mergedExp = dedupeCosts([...wixCosts, ...localExp]);

    financialData.invoices = mergedInv;
    financialData.expenses = mergedExp;

    // Persist & refresh UI
    saveData();
    updateDashboard();

    if (statusDiv) {
      financialData.wixSettings.lastSync = new Date().toISOString();
      saveData();
      statusDiv.className = 'integration-status connected';
      statusDiv.innerHTML = '<span>üü¢</span> Connected to Wix - Last sync: ' +
        new Date(financialData.wixSettings.lastSync).toLocaleString();
    }
  } catch (err) {
    console.warn('Wix sync failed:', err);
    if (statusDiv) {
      statusDiv.className = 'integration-status disconnected';
      statusDiv.innerHTML = '<span>üî¥</span> Wix sync failed: ' + (err?.message || err);
    }
    // Keep existing local/seeded data visible
    updateDashboard();
  }
}

/** Wire the existing ‚ÄúSync Now‚Äù button */
window.syncWithWix = async function () {
  await loadFromWixAndMerge();
};

/** Optional: auto-refresh every 10 minutes if Auto-Sync is not manual */
setInterval(() => {
  const freq = financialData?.wixSettings?.autoSyncFreq || 'manual';
  if (freq !== 'manual') loadFromWixAndMerge();
}, 10 * 60 * 1000);

// On first load, try to connect if both URL+API key are present
(function bootstrapWixLoad(){
  const hasUrl = !!(financialData?.wixSettings?.siteUrl);
  const hasKey = !!(financialData?.wixSettings?.apiKey);
  if (hasUrl && hasKey) loadFromWixAndMerge();
})();
</script>

</body>
</html>
